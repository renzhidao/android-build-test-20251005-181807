name: Android Build Test

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: ðŸ”§ è®¾ç½® Gradle Wrapper
      run: |
        chmod +x gradlew
        
    - name: ðŸ“¦ ä¸‹è½½ä¾èµ–
      continue-on-error: true
      run: |
        ./gradlew dependencies --stacktrace 2>&1 | tee dependencies.log
    
    - name: ðŸ—ï¸ æ‰§è¡ŒçœŸå®žçš„ Gradle æž„å»º
      continue-on-error: true
      run: |
        echo "========================================" | tee -a full_build.log
        echo "å¼€å§‹çœŸå®žçš„ Android æž„å»º" | tee -a full_build.log
        echo "æ—¶é—´: $(date)" | tee -a full_build.log
        echo "========================================" | tee -a full_build.log
        echo "" | tee -a full_build.log
        ./gradlew clean assembleDebug --stacktrace --info 2>&1 | tee -a full_build.log
        echo "" | tee -a full_build.log
        echo "========================================" | tee -a full_build.log
        echo "æž„å»ºç»“æŸ" | tee -a full_build.log
        echo "========================================" | tee -a full_build.log
    
    - name: ðŸ“‹ æ±‡æ€»è¯¦ç»†æ—¥å¿—
      if: always()
      run: |
        echo "========================================" > detailed_build_log.txt
        echo "Android çœŸå®žæž„å»ºå¤±è´¥æ—¥å¿—" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        echo "ä»“åº“: ${{ github.repository }}" >> detailed_build_log.txt
        echo "æäº¤: ${{ github.sha }}" >> detailed_build_log.txt
        echo "æž„å»ºæ—¶é—´: $(date)" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        echo "å®Œæ•´æž„å»ºæ—¥å¿—:" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        cat full_build.log >> detailed_build_log.txt 2>/dev/null || echo "æ— æž„å»ºæ—¥å¿—" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        echo "ä¾èµ–ä¿¡æ¯:" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        cat dependencies.log >> detailed_build_log.txt 2>/dev/null || echo "æ— ä¾èµ–æ—¥å¿—" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        echo "é¡¹ç›®ç»“æž„:" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        find . -type f -name "*.java" -o -name "*.gradle" -o -name "*.xml" | grep -v ".gradle/" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        echo "æ—¥å¿—æ–‡ä»¶å¤§å°: $(wc -l detailed_build_log.txt | awk '{print $1}') è¡Œ" >> detailed_build_log.txt
        
    - name: ðŸ“¤ ä¸Šä¼ å®Œæ•´æž„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-build-logs
        path: |
          detailed_build_log.txt
          full_build.log
          dependencies.log
          **/*.log
        retention-days: 7
